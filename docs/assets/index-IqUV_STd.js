(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class d{x;y;constructor(e,t){this.x=e,this.y=t}static add(e,t){return new d(e.x+t.x,e.y+t.y)}static subtract(e,t){return new d(e.x-t.x,e.y-t.y)}static scalarDivide(e,t){return new d(e.x/t,e.y/t)}static sqrt(e){return new d(Math.sqrt(e.x),Math.sqrt(e.y))}static distance(e,t){const i=d.subtract(e,t),s=i.x+i.y;return Math.sqrt(s)}}class S{static BACKGROUND_COLOR="#faf8f8ff ";static _paperPattern=null;static async loadPaperTexture(e,t=1){return new Promise(i=>{const s=new window.Image;s.src="/textures/paper_texture.jpg",s.onload=()=>{const n=document.createElement("canvas");n.width=s.width*t,n.height=s.height*t,n.getContext("2d").drawImage(s,0,0,n.width,n.height),S._paperPattern=e.createPattern(n,"repeat"),i()},s.onerror=()=>{i()}})}static render(e,t,i,s){e.clearRect(0,0,t.width,t.height),e.fillStyle=S.BACKGROUND_COLOR,e.fillRect(0,0,t.width,t.height),S._paperPattern&&(e.save(),e.globalAlpha=.5,e.fillStyle=S._paperPattern,e.fillRect(0,0,t.width,t.height),e.restore()),e.save(),i.applyTransform(e,t),s.graph.draw(),e.restore()}static calculateBidirectionalOffset(e,t,i){const s=Math.sqrt(e*e+t*t);if(s===0)return new d(0,0);const n=-t/s,a=e/s;return new d(n*i,a*i)}static calculateArrowPositions(e,t,i,s,n){const a=t.x-n*Math.cos(i),o=t.y-n*Math.sin(i);return{sourceX:e.x+s.x,sourceY:e.y+s.y,targetX:t.x+s.x,targetY:t.y+s.y,endX:a+s.x,endY:o+s.y}}static drawArrowhead(e,t,i,s,n,a){const o=n,c=a;e.beginPath(),e.moveTo(t,i),e.lineTo(t-o*Math.cos(s+c),i-o*Math.sin(s+c)),e.lineTo(t-o*Math.cos(s-c),i-o*Math.sin(s-c)),e.closePath(),e.fill()}}class A{static lineAngle(e,t){const i=t.x-e.x,s=t.y-e.y;return Math.atan2(s,i)}static distance(e,t){const i=e.x-t.x,s=e.y-t.y;return Math.sqrt(i*i+s*s)}static getMidpoint(e,t){const i=(e.x+t.x)/2,s=(e.y+t.y)/2;return new d(i,s)}static getBoxIntersect(e,t){const i=t._cachedDimensions.boxWidth/2,s=t._cachedDimensions.boxHeight/2,n=t.pos.x-e.x,a=t.pos.y-e.y;if(n===0&&a===0)return new d(t.pos.x,t.pos.y);const o=i/Math.abs(n),c=s/Math.abs(a),h=Math.min(o,c);return new d(t.pos.x-n*h,t.pos.y-a*h)}static circlePoints(e,t,i,s=100){const n=[];for(let a=0;a<s;a++){const o=2*Math.PI*a/s-Math.PI/2,c=e+i*Math.cos(o),h=t+i*Math.sin(o);n.push(new d(c,h))}return n}}const w={SIZE:18,FAMILY:"Open Sans",MASS_WEIGHT:1};class T{static getTextHeight(e){return e.actualBoundingBoxAscent+e.actualBoundingBoxDescent}static getFontString(e,t){return`bold ${t}px ${e}`}}class x{static clamp(e,t,i){return Math.max(t,Math.min(e,i))}static symmetricDifference(e,t){return new Set([...[...e].filter(i=>!t.has(i)),...[...t].filter(i=>!e.has(i))])}static difference(e,t){return new Set([...e].filter(i=>!t.has(i)))}static depthSearch(e,t,i=0,s=new Set){if(t<=i)return s;s.add(e);const n=e.neighbours;for(const a of n)s.has(a)||this.depthSearch(a,t,i+1,s);return s}static bfsComponents(e){const t=new Set,i=new Map;let s=0;for(const n of e){if(t.has(n))continue;const a=new Map,o=[];for(o.push({vertex:n,level:0}),t.add(n);o.length>0;){const{vertex:c,level:h}=o.shift();a.has(h)||a.set(h,[]),a.get(h).push(c);for(const l of g.getNeighbours(c))t.has(l)||(t.add(l),o.push({vertex:l,level:h+1}))}i.set(s++,a)}return i}}class g{static BOX_PADDING=15;static IMAGE_TEXT_GAP=20;static IMAGE_SIZE_MULTIPLIER=2.25;static MIN_IMAGE_SIZE=40;static TYPE_FONT_SIZE_REDUCTION=4;static MIN_TYPE_FONT_SIZE=12;static TEXT_LINE_SPACING=15;static TEXT_ONLY_BOX_EXTRA_HEIGHT=80;static pointInBoundary(e,t,i,s){const n=this.getBoundaries(t,s),a=i.canvasToWorld(e),o=n.left<=a.x&&a.x<=n.right,c=n.top<=a.y&&a.y<=n.bottom;return o&&c}static getBoundaries(e,t){this.ensureValidCache(e,t);const i=t.pos.x-t._cachedDimensions.boxWidth/2,s=t.pos.x+t._cachedDimensions.boxWidth/2,n=t.pos.y-t._cachedDimensions.boxHeight/2,a=t.pos.y+t._cachedDimensions.boxHeight/2;return{left:i,right:s,top:n,bottom:a}}static getNeighbours(e){let t=new Set;for(const i of e.connectedEdges)t.add(i.targetRef),t.add(i.sourceRef);return t}static getOriginalMass(e){return e.connectedEdges.length===0?1:e.connectedEdges.length}static drawTextVertex(e,t){const i=t._cachedDimensions,s=i.fontSize+g.TEXT_LINE_SPACING,n=t.pos.y-s/2,a=t.pos.y+s/2;e.font=T.getFontString(w.FAMILY,i.fontSize),e.textAlign="center",e.textBaseline="middle",e.fillStyle="black",e.fillText(t.label,t.pos.x,n);const o=Math.max(12,i.fontSize-g.TYPE_FONT_SIZE_REDUCTION);e.font=T.getFontString(w.FAMILY,o),e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillText(t.type,t.pos.x,a)}static drawImageVertex(e,t){const i=t._cachedDimensions,s=t.pos.x-i.boxWidth/2+i.padding+i.imgSize/2,n=t.pos.y,a=s+i.imgSize/2+i.gap,o=i.fontSize+g.TEXT_LINE_SPACING,c=t.pos.y-o/2,h=t.pos.y+o/2,l=t.thumbnail||t.img;e.save(),e.beginPath(),e.arc(s,n,i.imgSize/2,0,Math.PI*2),e.clip(),e.drawImage(l,s-i.imgSize/2,n-i.imgSize/2,i.imgSize,i.imgSize),e.restore(),e.beginPath(),e.strokeStyle="white",e.lineWidth=3,e.arc(s,n,i.imgSize/2,0,Math.PI*2),e.stroke(),e.font=T.getFontString(w.FAMILY,i.fontSize),e.textAlign="left",e.textBaseline="middle",e.fillStyle="black",e.fillText(t.label,a,c);const u=Math.max(12,i.fontSize-g.TYPE_FONT_SIZE_REDUCTION);e.font=T.getFontString(w.FAMILY,u),e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillText(t.type,a,h)}static calculateAndCacheDimensions(e,t,i){const s=this.getOriginalMass(t),n=i||x.clamp(w.SIZE+s*w.MASS_WEIGHT,M.LABEL_MIN_FONT,M.LABEL_MAX_FONT),a=!!(t.thumbnail||t.img&&t.img.complete&&t.img.naturalWidth>0);e.font=T.getFontString(w.FAMILY,n);const o=e.measureText(t.label),c=o.width,h=T.getTextHeight(o),l=Math.max(this.MIN_TYPE_FONT_SIZE,n-this.TYPE_FONT_SIZE_REDUCTION);e.font=T.getFontString(w.FAMILY,l);const u=e.measureText(t.type),y=u.width,_=T.getTextHeight(u),f=Math.max(c,y),E=Math.max(h,_);let R,L,I;if(a){const P=h+_+this.TEXT_LINE_SPACING;I=Math.max(this.MIN_IMAGE_SIZE,P*this.IMAGE_SIZE_MULTIPLIER);const F=I+this.IMAGE_TEXT_GAP+f,B=Math.max(I,P);R=F+this.BOX_PADDING*2,L=B+this.BOX_PADDING}else I=0,R=f+this.BOX_PADDING*2,L=h+_+this.BOX_PADDING+this.TEXT_ONLY_BOX_EXTRA_HEIGHT;t._cachedDimensions={labelWidth:c,labelHeight:h,typeWidth:y,typeHeight:_,maxTextWidth:f,maxTextHeight:E,imgSize:I,boxWidth:R,boxHeight:L,padding:this.BOX_PADDING,gap:this.IMAGE_TEXT_GAP,fontSize:n,label:t.label,type:t.type,hasImage:a}}static ensureValidCache(e,t){const i=this.getOriginalMass(t),s=w.SIZE+i*w.MASS_WEIGHT,n=t.img&&t.img.complete&&t.img.naturalWidth>0,a=t._cachedDimensions;return(!a||a.fontSize!==s||a.label!==t.label||a.type!==t.type||a.hasImage!==n)&&this.calculateAndCacheDimensions(e,t,s),t._cachedDimensions}}class m{static LINE_SIZE=4;static ARROW_HEAD_SIZE=30;static ARROW_HEAD_ANGLE=Math.PI/6;static BIDIRECTIONAL_OFFSET_SCALE=20;static LABEL_DISTANCE_FROM_MIDPOINT=20;static LABEL_PADDING=40;static LABEL_MAX_FONT=24;static LABEL_MIN_FONT=12;static LABEL_COLOUR="#2e2e2eff";_sourceId;_sourceRef;_targetId;_targetRef;_isBidirectional;_types;edgeColour;constructor(e,t,i,s,n=!1){if(this._sourceId=e,this._targetId=t,this._isBidirectional=n,this._types=[i],this.edgeColour="#000000",this._sourceRef=s.getVertex(e),this._targetRef=s.getVertex(t),!this._sourceRef||!this._targetRef)throw new Error(`Invalid vertex IDs: source=${e}, target=${t}`)}get targetRef(){return this._targetRef}get sourceRef(){return this._sourceRef}set isBidirectional(e){this._isBidirectional=e}get mainType(){return this.types[0]}get types(){return this._types}set types(e){this._types=e}draw(e){e.strokeStyle=this.edgeColour||"#00000012",e.fillStyle=this.edgeColour,e.lineWidth=m.LINE_SIZE,this.drawArrow(e,this._sourceRef,this._targetRef),this.drawLabelText(e)}drawLabelText(e){const t=this.sourceRef.pos,i=this.targetRef.pos;g.ensureValidCache(e,this.sourceRef),g.ensureValidCache(e,this.targetRef);const s=A.getBoxIntersect(i,this.sourceRef),n=A.getBoxIntersect(t,this.targetRef);let a="";for(let V=0;V<this._types.length;V++)a+=this._types[V],V!=this._types.length-1&&(a+=", ");const o=m.LABEL_PADDING,h=(A.distance(s,n)-o)*.7;if(h<=0)return;const l=m.LABEL_MAX_FONT,u=m.LABEL_MIN_FONT;let y=l;for(;y>u&&(e.font=`bold ${y}px ${w.FAMILY}`,!(e.measureText(a).width<=h));)y-=1;const _=e.measureText(a);if(_.width>=h)return;const f=A.getMidpoint(s,n);let E=A.lineAngle(t,i);const R=E+Math.PI/2;let L=m.LABEL_DISTANCE_FROM_MIDPOINT+T.getTextHeight(_)/2;this._isBidirectional&&(L+=m.BIDIRECTIONAL_OFFSET_SCALE);const I=new d(f.x+L*Math.cos(R),f.y+L*Math.sin(R));(E>Math.PI/2||E<-Math.PI/2)&&(E+=Math.PI);const P=n.x-t.x,F=n.y-t.y,B=Math.atan2(F,P),H=m.ARROW_HEAD_SIZE,$=H*Math.cos(B),Z=H*Math.sin(B);I.x-=$,I.y-=Z,e.save(),e.translate(I.x,I.y),e.rotate(E),e.textAlign="center",e.textBaseline="middle",e.fillStyle=m.LABEL_COLOUR,e.fillText(a,0,0),e.restore()}drawArrow(e,t,i){const s=t.pos,n=A.getBoxIntersect(s,i),a=n.x-s.x,o=n.y-s.y,c=Math.atan2(o,a);let h=new d(0,0);this._isBidirectional&&(h=S.calculateBidirectionalOffset(a,o,m.BIDIRECTIONAL_OFFSET_SCALE));const l=S.calculateArrowPositions(s,n,c,h,m.ARROW_HEAD_SIZE);e.beginPath(),e.moveTo(l.sourceX,l.sourceY),e.lineTo(l.endX,l.endY),e.stroke(),S.drawArrowhead(e,l.targetX,l.targetY,c,m.ARROW_HEAD_SIZE,m.ARROW_HEAD_ANGLE)}}class j{static queue=[];static started=!1;static push(e){this.queue.push(e),this.started||(this.started=!0,this.process())}static process(){if(this.queue.length>0){const e=this.queue.shift();e&&e()}requestAnimationFrame(()=>this.process())}}const q=256,Q=2,U={THUMBNAIL_SIZE:q,MAXIMUM_ATTEMPTS:Q},K=U.THUMBNAIL_SIZE;class M{static MAX_SPEED=15;static DAMPING=.9;static RECT_RADIX=40;static VERTEX_COLOUR="#fffbe6";static LABEL_MAX_FONT=22;static LABEL_MIN_FONT=18;_pos;_velocity;_connectedEdges;_selected;_id;_type;_wikiTitle;img;thumbnail;_label;textWidth;textHeight;labelColour;expanding=!1;_cachedDimensions;constructor(e,t,i="",s="",n="",a){if(this._pos=new d(200,200),this._velocity=new d(0,0),this._id=e,this._label=t,this._type=i,this._wikiTitle=n,this._selected=!1,this._connectedEdges=[],s!=""){const o=new Image;o.src=s,o.onload=()=>{j.push(()=>{const c=K,h=document.createElement("canvas");h.width=c,h.height=c,h.getContext("2d").drawImage(o,0,0,c,c),this.thumbnail=h,this.img=void 0})}}this.labelColour=void 0,this._cachedDimensions=g.ensureValidCache(a,this)}get velocity(){return this._velocity}killVelocity(){this._velocity=new d(0,0)}get connectedEdges(){return this._connectedEdges}get neighbours(){const e=new Set;for(const t of this.connectedEdges)t.sourceRef!==this&&e.add(t.sourceRef),t.targetRef!==this&&e.add(t.targetRef);return e}set selected(e){this._selected=e}get selected(){return this._selected}get id(){return this._id}get type(){return this._type}get label(){return this._label}get wikiTitle(){return this._wikiTitle}get pos(){return this._pos}update(){if(this.selected)return;const e=M.MAX_SPEED;this._pos.x+=x.clamp(this._velocity.x,-e,e),this._pos.y+=x.clamp(this._velocity.y,-e,e),this._velocity.x*=M.DAMPING,this._velocity.y*=M.DAMPING}draw(e){const t=g.ensureValidCache(e,this),i=this.pos.x-t.boxWidth/2,s=this.pos.y-t.boxHeight/2;e.fillStyle=M.VERTEX_COLOUR,e.beginPath(),e.roundRect(i,s,t.boxWidth,t.boxHeight,M.RECT_RADIX),e.fill(),t.hasImage?g.drawImageVertex(e,this):g.drawTextVertex(e,this);let a=this._selected?"yellow":this.labelColour,o=this._selected?8:5;if(this.expanding){const c=performance.now(),h=(Math.sin(c/250)+1)/2;a=`rgba(102, 126, 234, ${.5+.5*h})`,o=7+5*h}e.strokeStyle=a,e.lineWidth=o,e.beginPath(),e.roundRect(i,s,t.boxWidth,t.boxHeight,M.RECT_RADIX),e.stroke()}}class C{static MOUSE_SPEED_FACTOR=1;static ZOOM_SCALE_FACTOR=1.1;_pos;_zoom;_cameraLockedVertex;constructor(){this._pos=new d(0,0),this._zoom=1,this._cameraLockedVertex=null}get cameraLockedVertex(){return this._cameraLockedVertex}set cameraLockedVertex(e){this._cameraLockedVertex=e}canvasToWorld(e){const t=(e.x-this._pos.x)/this._zoom,i=(e.y-this._pos.y)/this._zoom;return new d(t,i)}applyTransform(e,t){if(this._cameraLockedVertex){const i=this._cameraLockedVertex.pos,s=new d(t.width/2-i.x*this._zoom,t.height/2-i.y*this._zoom);this._pos=s}e.translate(this._pos.x,this._pos.y),e.scale(this._zoom,this._zoom)}pan(e,t){this._pos.x+=e*C.MOUSE_SPEED_FACTOR,this._pos.y+=t*C.MOUSE_SPEED_FACTOR}zoomAt(e,t,i){const s=i<0?C.ZOOM_SCALE_FACTOR:1/C.ZOOM_SCALE_FACTOR;this._zoom*=s,this._pos.x=e.x-t.x*this._zoom,this._pos.y=e.y-t.y*this._zoom}}let b,v=null;function J(){return(v===null||v.byteLength===0)&&(v=new Uint8Array(b.memory.buffer)),v}let k=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&k.decode();const ee=2146435072;let G=0;function te(r,e){return G+=e,G>=ee&&(k=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}},k.decode(),G=e),k.decode(J().subarray(r,r+e))}function se(r,e){return r=r>>>0,te(r,e)}function ie(r,e,t,i,s,n,a,o,c,h,l){return b.repulsion(r,e,t,i,s,n,a,o,c,h,l)}const ne=new Set(["basic","cors","default"]);async function ae(r,e){if(typeof Response=="function"&&r instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(r,e)}catch(i){if(r.ok&&ne.has(r.type)&&r.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",i);else throw i}const t=await r.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{const t=await WebAssembly.instantiate(r,e);return t instanceof WebAssembly.Instance?{instance:t,module:r}:t}}function oe(){const r={};return r.wbg={},r.wbg.__wbg_of_220eb661e8455fb5=function(e,t,i,s){return Array.of(e,t,i,s)},r.wbg.__wbg_wbindgenthrow_4c11a24fca429ccf=function(e,t){throw new Error(se(e,t))},r.wbg.__wbindgen_cast_d6cd19b81560fd6e=function(e){return e},r.wbg.__wbindgen_init_externref_table=function(){const e=b.__wbindgen_export_0,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)},r}function re(r,e){return b=r.exports,z.__wbindgen_wasm_module=e,v=null,b.__wbindgen_start(),b}async function z(r){if(b!==void 0)return b;typeof r<"u"&&(Object.getPrototypeOf(r)===Object.prototype?{module_or_path:r}=r:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof r>"u"&&(r=new URL("/Force-Directed-Graph-Redux/assets/fdg_wasm_bg-Bvg0-fTm.wasm",import.meta.url));const e=oe();(typeof r=="string"||typeof Request=="function"&&r instanceof Request||typeof URL=="function"&&r instanceof URL)&&(r=fetch(r));const{instance:t,module:i}=await ae(await r,e);return re(t,i)}class X{static STRENGTH=800;static repulsion(e,t=X.STRENGTH,i=1){for(let s=0;s<e.length;s++)for(let n=s+1;n<e.length;n++){const a=e[s],o=e[n],c=a._cachedDimensions.boxWidth/2+o._cachedDimensions.boxWidth/2,h=ie(t,a.pos.x,a.pos.y,a.selected,g.getOriginalMass(a),o.pos.x,o.pos.y,o.selected,g.getOriginalMass(o),c,i),[l,u,y,_]=h;a.velocity.x+=l,a.velocity.y+=u,o.velocity.x-=y,o.velocity.y-=_}}}class O{static SPRING=.025;static CENTRAL_SPRING=.05;static REST_LENGTH=10;static centerAttraction(e,t){const i=new d(t.width/2,t.height/2);e.forEach(s=>{if(s.selected)return;const n=i.x-s.pos.x,a=i.y-s.pos.y;s.velocity.x+=n*O.CENTRAL_SPRING,s.velocity.y+=a*O.CENTRAL_SPRING})}static springAttraction(e,t=O.SPRING){for(const i of e){const s=i.sourceRef,n=i.targetRef,a=n.pos.x-s.pos.x,o=n.pos.y-s.pos.y,c=Math.sqrt(a*a+o*o);if(c===0)continue;const h=a/c,l=o/c,u=s._cachedDimensions.boxWidth/2+n._cachedDimensions.boxWidth/2,_=(g.getOriginalMass(s)+g.getOriginalMass(n))/2+O.REST_LENGTH,f=c-(_+u),E=t*f;s.selected||(s.velocity.x+=E/g.getOriginalMass(s)*h,s.velocity.y+=E/g.getOriginalMass(s)*l),n.selected||(n.velocity.x-=E/g.getOriginalMass(n)*h,n.velocity.y-=E/g.getOriginalMass(n)*l)}}}class p{static COLOURS={HUE_MIN:0,HUE_MAX:359,SATURATION_MIN:60,SATURATION_MAX:80,LIGHTNESS_MIN:30,LIGHTNESS_MAX:45};static PALETTE=["#1d3557","#e63946","#457b9d","#f4a261","#2a9d8f","#264653","#e76f51","#a8dadc","#ffb703","#6d597a","#22223b","#4b3f2a","#43aa8b","#f3722c","#277da1"];static _paletteIndex=0;static nextNiceColor(){const e=p.PALETTE[p._paletteIndex%p.PALETTE.length];return p._paletteIndex++,e}static assignUniqueColours(e,t,i,s){for(const n of e){const a=i(n);if(t.has(a))s(n,t.get(a));else{let o;const c=new Set(t.values());do o=p.randomNiceColor();while(c.has(o));t.set(a,o),s(n,o)}}}static randomNiceColor(){if(this.PALETTE.length<=this._paletteIndex){const e=Math.floor(Math.random()*p.COLOURS.HUE_MAX)+p.COLOURS.HUE_MIN,t=Math.floor(Math.random()*p.COLOURS.SATURATION_MAX)+p.COLOURS.SATURATION_MIN,i=Math.floor(Math.random()*p.COLOURS.LIGHTNESS_MAX)+p.COLOURS.LIGHTNESS_MIN;return`hsl(${e}, ${t}%, ${i}%)`}else return this.nextNiceColor()}static browserToCanvas(e,t){const i=e.getBoundingClientRect(),s=t.clientX-i.left,n=t.clientY-i.top;return new d(s,n)}static resizeCanvas(e){e.width=window.innerWidth-300,e.height=window.innerHeight}}class N{static INITIAL_RADIUS=100;_objectColours=new Map;_ctx;_canvas;_vertices;_edges;_componentOrigins;_selectedVertex;_lastClickedVertex;constructor(e,t){this._ctx=e,this._canvas=t,this._vertices={},this._edges=[],this._componentOrigins=new Set}get vertices(){return this._vertices}get edges(){return this._edges}get selectedVertex(){return this._selectedVertex}get lastClickedVertex(){return this._lastClickedVertex}getVertex(e){return this._vertices[e]}edgeExists(e,t,i){for(const s of this.edges)if(s.sourceRef.id===e&&s.targetRef.id===t){for(const n of s.types)if(i===n)return!0}return!1}edgeExistsDifferentProperty(e,t,i){for(const s of this._edges)if(s.sourceRef.id===e&&s.targetRef.id===t){const a=s.types;for(const o of a)if(o===i)return!1;return s.types.push(i),!0}return!1}biDirectional(e,t){for(const i of this.edges)if(i.targetRef.id===e&&i.sourceRef.id===t)return i}addEdge(e,t,i){if(this.edgeExists(e,t,i)||this.edgeExistsDifferentProperty(e,t,i))return!1;const s=this.getVertex(e),n=this.getVertex(t);if(!s||!n)return console.error("Cannot create edge: vertex not found"),!1;const a=this.biDirectional(e,t);let o=!1;a&&(a.isBidirectional=!0,o=!0);const c=new m(e,t,i,this,o);return s.connectedEdges.push(c),n.connectedEdges.push(c),this._edges.push(c),!0}simulate(){X.repulsion(this.getVertices()),O.springAttraction(this._edges),O.centerAttraction(this._componentOrigins,this._canvas),this.update()}setSelectedVertex(e){e.killVelocity(),e.selected=!0,this._selectedVertex=e,this._lastClickedVertex=e}resetSelectedVertex(){this.selectedVertex!==void 0&&(this.selectedVertex.selected=!1,this._selectedVertex=void 0)}appendVerticesPos(e,t=void 0,i=N.INITIAL_RADIUS){if(t===void 0){let a=new d(0,0),o=0;for(const c of this.getVertices())e[c.id]||(a=d.add(a,c.pos),o++);o===0?t=new d(this._canvas.width/2,this._canvas.height/2):t=d.scalarDivide(a,o)}let s=Object.values(e),n=A.circlePoints(t.x,t.y,i,s.length);for(let a=0;a<s.length;a++)s[a].pos.x=n[a].x,s[a].pos.y=n[a].y}updateComponents(e=this.getVertices()){const t=x.bfsComponents(e);return t.forEach(i=>{this._componentOrigins.add(i.get(0)[0])}),t}initVerticesPos(e=this.getVertices()){const t=this.updateComponents(e),i=[...t.keys()].length,s=A.circlePoints(this._canvas.width/2,this._canvas.height/2,N.INITIAL_RADIUS,i);for(const[n,a]of t.entries()){const o=s[n],c=o.x,h=o.y;for(const[l,u]of a.entries()){const y=(l+1)*N.INITIAL_RADIUS,_=A.circlePoints(c,h,y,u.length);for(let f=0;f<u.length;f++)u[f].pos.x=_[f].x,u[f].pos.y=_[f].y}}}initVertexColour(){p.assignUniqueColours(this.getVertices(),this._objectColours,e=>e.type,(e,t)=>e.labelColour=t)}initEdgeColour(){p.assignUniqueColours(this._edges,this._objectColours,e=>e.mainType,(e,t)=>e.edgeColour=t)}getVertices(){return Object.values(this._vertices)}update(){for(const e of this.getVertices())e.update()}draw(){this._edges.forEach(e=>e.draw(this._ctx));for(const e of this.getVertices())e.draw(this._ctx)}clear(){this._vertices={},this._edges=[],this._componentOrigins=new Set,this._selectedVertex=void 0,this._lastClickedVertex=void 0}}class D{static API_BASE="https://wikidatatoentitygraph-production.up.railway.app/api";static async fetchQIDByName(e){const t=`https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(e)}&language=en&format=json&origin=*`,s=await(await fetch(t)).json();return s.search&&s.search.length>0?s.search[0].id:null}static async fetchGraphData(e,t=1,i=5){try{const s=`${D.API_BASE}/graph/${e}?depth=${t}&relation_limit=${i}`,n=await fetch(s);if(!n.ok)throw new Error(`Server error: ${n.status} ${n.statusText}`);return await n.json()}catch(s){throw console.error(`Failed to fetch graph data for ${e}:`,s),s}}static async flushSever(e){await e.fetchRelations("Q1",1,1),e.clearGraph()}}class ce{_graph;_ctx;constructor(e,t){this._ctx=e,this._graph=new N(e,t)}get graph(){return this._graph}get ctx(){return this._ctx}async fetchRelations(e,t,i,s=!1){try{if(!e)return this._graph;const n=await D.fetchGraphData(e,t,i);return this.parseAndAddToGraph(n.data,s),this._graph}catch(n){throw console.error("Error loading graph:",n),n}}parseAndAddToGraph(e,t=!1,i=void 0){const s=new Set(Object.keys(this._graph.vertices));t||this._graph.clear();for(const[n,a]of Object.entries(e.entities))this._graph.vertices[n]||(this._graph.vertices[n]=new M(n,a.label,a.type,a.image,a.wikipedia,this._ctx));for(const[n,a]of Object.entries(e.relations))for(const[o,c]of Object.entries(a)){const h=e.properties[o]||o;for(const l of c){const u=this._graph.vertices[n],y=this._graph.vertices[l];!u||!y||this._graph.addEdge(n,l,h)}}if(t){const n={};for(const a of Object.keys(this._graph.vertices))s.has(a)||(n[a]=this._graph.vertices[a]);Object.keys(n).length>0&&this._graph.appendVerticesPos(n,i)}else this._graph.initVerticesPos();this._graph.initVertexColour(),this._graph.initEdgeColour()}async expandVertex(e,t,i,s){let n=new Set;for(let a=1;a<i+1;a++){const o=x.depthSearch(e,a),c=x.difference(o,n);for(const h of c)h.expanding=!0,await t.expandTillLimit(h,s),h.expanding=!1,n.add(h)}}async appendVertexExpansion(e,t,i=5){try{const s=await D.fetchGraphData(e,t,i),n=!0,a=this._graph.getVertex(e);return this.parseAndAddToGraph(s.data,n,a.pos),this._graph}catch(s){throw console.error("Error expanding graph:",s),s}}async expandTillLimit(e,t){const i=U.MAXIMUM_ATTEMPTS;let s=0,n=0;for(;e.connectedEdges.length<t;){n++;let a=e.connectedEdges.length;if(await this.appendVertexExpansion(e.id,1,t+n),a===e.connectedEdges.length&&(s+=1),s===i)break}}clearGraph(){this._graph.clear()}simulate(){this._graph.simulate()}getVertices(){return this._graph.vertices}getEdges(){return this._graph.edges}isEmpty(){return Object.keys(this._graph.vertices).length===0}}class he{_graphManager;_suggestions;_selectedSuggestion=-1;_elements;constructor(e){this._graphManager=e,this._suggestions=[],this._elements=this.getElements(),this.setupEventListeners(),this.updateDepthDisplay(),this.updateEntityLimitDisplay(),this.startStatsUpdate()}getElements(){return{fetchButton:document.getElementById("fetch-graph"),clearButton:document.getElementById("clear-graph"),wikiInput:document.getElementById("wiki-input"),suggestionsDiv:document.getElementById("suggestions"),appendMode:document.getElementById("append-mode"),depthSlider:document.getElementById("depth-slider"),depthValue:document.getElementById("depth-value"),relationLimit:document.getElementById("relation-limit"),relationLimitValue:document.getElementById("relation-limit-value"),graphStats:document.getElementById("graph-stats")}}setupEventListeners(){this._elements.fetchButton?.addEventListener("click",()=>this.handleFetchGraph()),this._elements.wikiInput?.addEventListener("input",()=>this.handleInputSuggestions()),this._elements.wikiInput?.addEventListener("keydown",e=>this.handleSuggestionKeydown(e)),this._elements.clearButton?.addEventListener("click",()=>this.handleClearGraph()),this._elements.depthSlider?.addEventListener("input",()=>this.updateDepthDisplay()),this._elements.relationLimit?.addEventListener("input",()=>this.updateEntityLimitDisplay()),this._elements.suggestionsDiv?.addEventListener("mousedown",e=>this.handleSuggestionClick(e))}handleSuggestionClick(e){const i=e.target.closest("div[data-index]");if(i){const s=parseInt(i.getAttribute("data-index"));this.selectSuggestion(s)}}selectSuggestion(e){const t=this._suggestions[e];t&&(this._elements.wikiInput.value=t.label,this._elements.suggestionsDiv.innerHTML="",this._suggestions=[],this._selectedSuggestion=-1,this.handleFetchGraph())}async handleInputSuggestions(){const e=this._elements.wikiInput?.value.trim();if(!e){this._suggestions=[],this.renderSuggestions();return}try{const t=`https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(e)}&language=en&format=json&origin=*`,n=((await(await fetch(t)).json()).search||[]).slice(0,4).map(a=>({id:a.id,label:a.label}));this._suggestions=n,this.renderSuggestions()}catch(t){throw t}}renderSuggestions(){const e=this._suggestions,t=this._elements.suggestionsDiv;if(e.length===0){t.innerHTML="",t.style.display="none";return}t.style.display="block",t.innerHTML=e.map((i,s)=>`<div class="${s===this._selectedSuggestion?"selected":""}" data-index="${s}">
                <strong>${i.label}</strong> <span style="color:#888;">${i.id}</span>
            </div>`).join("")}handleSuggestionKeydown(e){this._suggestions.length&&(e.key==="ArrowDown"?(this._selectedSuggestion=Math.min(this._selectedSuggestion+1,this._suggestions.length-1),this.renderSuggestions(),e.preventDefault()):e.key==="ArrowUp"?(this._selectedSuggestion=Math.max(this._selectedSuggestion-1,0),this.renderSuggestions(),e.preventDefault()):e.key==="Enter"&&this._selectedSuggestion>=0&&(this.selectSuggestion(this._selectedSuggestion),e.preventDefault()))}async handleFetchGraph(){try{this.setLoadingState(!0);const e=this.getSettings();let t=this._elements.wikiInput?.value.trim().toUpperCase()||"Q1";if(!/^Q\d+$/.test(t)){const s=await D.fetchQIDByName(t);if(s)t=s;else{this.showError("No Wikidata entity found for that name.");return}}const i=e.appendMode&&!this._graphManager.isEmpty();await this._graphManager.fetchRelations(t,e.depth,e.relationLimit,i),i&&this._graphManager.graph.updateComponents(),this.showSuccess(`Graph loaded for: ${t}`)}catch(e){console.error("Error fetching graph:",e),this.showError("Failed to fetch graph data")}finally{this.setLoadingState(!1)}}handleClearGraph(){this._graphManager.clearGraph(),this.showSuccess("Graph cleared")}setLoadingState(e){this._elements.fetchButton&&(this._elements.fetchButton.disabled=e,this._elements.fetchButton.textContent=e?"Loading...":"Fetch Graph"),this._elements.clearButton&&(this._elements.clearButton.disabled=e);const t=document.getElementById("loading-spinner");t&&(t.style.display=e?"flex":"none")}updateDepthDisplay(){this._elements.depthSlider&&this._elements.depthValue&&(this._elements.depthValue.textContent=this._elements.depthSlider.value)}updateEntityLimitDisplay(){this._elements.relationLimit&&this._elements.relationLimitValue&&(this._elements.relationLimitValue.textContent=this._elements.relationLimit.value)}startStatsUpdate(){setInterval(()=>this.updateStats(),1e3)}updateStats(){if(this._elements.graphStats){const e=Object.keys(this._graphManager.getVertices()).length,t=this._graphManager.getEdges().length;this._elements.graphStats.textContent=`Vertices: ${e} | Edges: ${t}`}}showSuccess(e){console.log(`✅ ${e}`)}showError(e){console.error(`❌ ${e}`)}getSettings(){return{depth:x.clamp(parseInt(this._elements.depthSlider?.value||"1"),1,5),relationLimit:x.clamp(parseInt(this._elements.relationLimit?.value||"5"),1,10),appendMode:this._elements.appendMode?.checked||!1,entityId:this._elements.wikiInput?.value.trim()||"Q1"}}updateUIState(){const e=this._graphManager.isEmpty();this._elements.appendMode&&(this._elements.appendMode.disabled=e),this._elements.clearButton&&(this._elements.clearButton.disabled=e)}}class le{canvas;camera;graphManager;uiController;isDraggingCamera=!1;isExpandingVertex=!1;clickTimer=null;constructor(e,t,i,s){this.canvas=e,this.camera=t,this.graphManager=i,this.uiController=s,this.setupEventListeners()}setupEventListeners(){this.canvas.addEventListener("contextmenu",e=>this.handleRightClick(e)),this.canvas.addEventListener("mousedown",e=>this.handleMouseDown(e)),this.canvas.addEventListener("mousemove",e=>this.handleMouseMove(e)),this.canvas.addEventListener("mouseup",()=>this.handleMouseUp()),this.canvas.addEventListener("mouseleave",()=>this.handleMouseLeave()),this.canvas.addEventListener("wheel",e=>this.handleWheel(e))}async handleRightClick(e){if(e.preventDefault(),this.isExpandingVertex)return;let i=this.graphManager.graph.lastClickedVertex;if(i){const s=this.uiController.getSettings();this.isExpandingVertex=!0,await this.graphManager.expandVertex(i,this.graphManager,s.depth,s.relationLimit),this.isExpandingVertex=!1}}handleMouseDown(e){const t=p.browserToCanvas(this.canvas,e),i=this.graphManager.graph;let s=null;for(const n of Object.values(i.vertices))g.pointInBoundary(t,this.graphManager.ctx,this.camera,n)&&(s=n);if(s===null){this.isDraggingCamera=!0;return}if(this.graphManager.graph.setSelectedVertex(s),s&&(e.ctrlKey||e.metaKey)){const n=`https://en.wikipedia.org/wiki/${encodeURIComponent(s.wikiTitle)}`;window.open(n,"_blank","noopener,noreferrer");return}this.clickTimer?(clearTimeout(this.clickTimer),this.clickTimer=null,this.camera.cameraLockedVertex=s):this.clickTimer=setTimeout(()=>{this.clickTimer=null},250)}handleMouseMove(e){if(this.isDraggingCamera)this.camera.cameraLockedVertex=null,this.camera.pan(e.movementX,e.movementY);else{const t=this.graphManager.graph;if(t.selectedVertex){if(this.camera.cameraLockedVertex===t.selectedVertex)return;const i=p.browserToCanvas(this.canvas,e),s=this.camera.canvasToWorld(i);t.selectedVertex.pos.x=s.x,t.selectedVertex.pos.y=s.y}}}handleWheel(e){e.preventDefault();const t=p.browserToCanvas(this.canvas,e),i=this.camera.canvasToWorld(t);this.camera.zoomAt(t,i,e.deltaY)}handleMouseUp(){this.isDraggingCamera=!1,this.graphManager.graph.resetSelectedVertex()}handleMouseLeave(){this.isDraggingCamera=!1,this.graphManager.graph.resetSelectedVertex()}}const W=[];function Y(){if(W.length>0){const r=W.shift();r&&r()}requestAnimationFrame(Y)}Y();class de{canvas;ctx;camera;graphManager;uiController;inputManager;constructor(){if(this.canvas=document.getElementById("graphCanvas"),!this.canvas)throw new Error("Canvas element with id 'graphCanvas' not found");if(this.ctx=this.canvas.getContext("2d"),!this.ctx)throw new Error("Unable to get 2D context from canvas");this.setupCanvas(),this.initializeComponents(),this.startRenderLoop()}setupCanvas(){p.resizeCanvas(this.canvas),window.addEventListener("resize",()=>{p.resizeCanvas(this.canvas)})}initializeComponents(){this.camera=new C,this.graphManager=new ce(this.ctx,this.canvas),this.uiController=new he(this.graphManager),this.inputManager=new le(this.canvas,this.camera,this.graphManager,this.uiController)}async startRenderLoop(){await D.flushSever(this.graphManager),await S.loadPaperTexture(this.ctx);const e=()=>{this.graphManager.simulate(),S.render(this.ctx,this.canvas,this.camera,this.graphManager),requestAnimationFrame(e)};e()}}window.onload=async()=>{await z();try{new de,console.log("Application started successfully")}catch(r){console.error("Failed to start application:",r)}};
